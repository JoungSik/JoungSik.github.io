<!DOCTYPE html>
<html lang="ko-kr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://joungsik.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://joungsik.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://joungsik.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://joungsik.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://joungsik.github.io/css/light.css' />
    <link rel="stylesheet" href='https://joungsik.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://joungsik.github.io/css/syntax.css' />
    <title>Kamal로 Redmine 배포하기:Docker 컨테이너화부터 자동화까지 2장 - Joungsik의 기술 블로그</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github-mark-white.png'>
    
    <meta name="theme-color" content="#1e2327">

    <link rel="stylesheet" href="https://joungsik.github.io/css/custom.css">
    <script type="text/javascript" src="https://joungsik.github.io/js/application.js"></script>

    
    <meta name="description"
  content="이전 장에서 Docker 컨테이너화한 Redmine을 이번 장에서는 Kamal을 활용해 실제 배포하는 과정을 다룹니다. Kamal의 개념과 설정 방법, 배포 구성(config) 설명, GitHub Actions를 통한 main 브랜치 커밋 시 자동 배포까지 실무 경험을 바탕으로 설명합니다." />
<meta name="keywords"
  content='Kamal, Redmine 배포, Docker, 배포 자동화, GitHub Actions, 웹 애플리케이션 배포' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://joungsik.github.io/post/kamal%EB%A1%9C-redmine-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0docker-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88%ED%99%94%EB%B6%80%ED%84%B0-%EC%9E%90%EB%8F%99%ED%99%94%EA%B9%8C%EC%A7%80-2%EC%9E%A5/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Kamal로 Redmine 배포하기:Docker 컨테이너화부터 자동화까지 2장 - Joungsik의 기술 블로그" />
<meta name="twitter:description"
  content="이전 장에서 Docker 컨테이너화한 Redmine을 이번 장에서는 Kamal을 활용해 실제 배포하는 과정을 다룹니다. Kamal의 개념과 설정 방법, 배포 구성(config) 설명, GitHub Actions를 통한 main 브랜치 커밋 시 자동 배포까지 실무 경험을 바탕으로 설명합니다." />
<meta name="twitter:site" content="https://joungsik.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://joungsik.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Kamal로 Redmine 배포하기:Docker 컨테이너화부터 자동화까지 2장 - Joungsik의 기술 블로그">
<meta property="og:description"
  content="이전 장에서 Docker 컨테이너화한 Redmine을 이번 장에서는 Kamal을 활용해 실제 배포하는 과정을 다룹니다. Kamal의 개념과 설정 방법, 배포 구성(config) 설명, GitHub Actions를 통한 main 브랜치 커밋 시 자동 배포까지 실무 경험을 바탕으로 설명합니다." />
<meta property="og:url" content="https://joungsik.github.io/post/kamal%EB%A1%9C-redmine-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0docker-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88%ED%99%94%EB%B6%80%ED%84%B0-%EC%9E%90%EB%8F%99%ED%99%94%EA%B9%8C%EC%A7%80-2%EC%9E%A5/" />
<meta property="og:site_name" content="Kamal로 Redmine 배포하기:Docker 컨테이너화부터 자동화까지 2장" />
<meta property="og:image"
  content="https://joungsik.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2025-08-10 12:15:55 &#43;0900 &#43;0900" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://joungsik.github.io/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" id="search-form" action="" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://joungsik.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://joungsik.github.io/">
                  <img class=" avatar-user"
                    src="https://avatars.githubusercontent.com/u/6128807?v=4"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://joungsik.github.io/">JoungSik</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://joungsik.github.io/post/kamal%EB%A1%9C-redmine-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0docker-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88%ED%99%94%EB%B6%80%ED%84%B0-%EC%9E%90%EB%8F%99%ED%99%94%EA%B9%8C%EC%A7%80-2%EC%9E%A5/">Kamal로 Redmine 배포하기:Docker 컨테이너화부터 자동화까지 2장</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sun, 10 Aug 2025 12:15:55 &#43;0900"
                    class="no-wrap">
                    Sun, 10 Aug 2025 12:15:55 &#43;0900</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Fri, 22 Aug 2025 13:45:07 &#43;0000"
                    class="no-wrap">
                    Fri, 22 Aug 2025 13:45:07 &#43;0000</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1447 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/kamal">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Kamal
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/redmine">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Redmine
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/docker">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Docker
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h2 id="시작하며">시작하며</h2>
<p>이전 장에서는 Redmine을 Docker화 하는 과정을 이야기 했고 이번 장에서는 Docker화 한 이미지를 Kamal을 활용해 배포하는 내용에 대해서 작성하려고 합니다.</p>
<h2 id="kamal">Kamal</h2>
<p>Kamal은 Docker를 활용해서 웹 앱을 배포하고 관리하는데 필요한 것들을 제공해주는 프로그램입니다.
제작자는 Rails 의 창시자라고 불리는 DHH (David Heinemeier Hansson) 가 이끄는 37signals 라는 조직에서 사용하고 있습니다.</p>
<p>Kamal이 만들어진 동기에는 AWS나 GCP와 같은 클라우드의 높은 비용과 Kubernetes의 복잡성에 의한 좌절감에서 만들어졌습니다.</p>
<p>Kamal은 기본적으로 Docker를 기반으로 동작하며 코드는 <a href="https://github.com/basecamp/kamal">여기</a>에서 확인할 수 있습니다.</p>
<p>실제로 사용해봤을 때 여러 커스텀 적용을 하려다보니 새롭게 알게 되는 사실들이 많았습니다.</p>
<p>그리고 사용을 하다보니 Rails와 같은 웹 앱을 배포하는 것에 있어 Docker를 사용한다면 가볍게 사용하기에 Kamal만큼 좋은 것이 없다는 생각이 들 정도로 좋았습니다.</p>
<p>Kamal의 특징 중에는 또 무중단 배포가 제게는 가장 좋았던 부분인데 이를 알게 된 것은 배포 이후 container name을 고정하기 위해 옵션을 찾아보던 중에 알게 되었습니다.</p>
<p>우선 Kamal은 deploy 시 다음의 과정을 거치게 됩니다.</p>
<ol>
<li>Dockerfile 기반의 Docker 이미지 빌드</li>
<li>빌드된 Docker 이미지를 특정 registry로의 push</li>
<li>원격지 서버에서 Docker 이미지 pull -&gt; Docker 네트워크 생성 및 연결</li>
<li>신규 Docker 컨테이너를 같은 네트워크의 같은 서비스 이름 실행 후 health 체크</li>
<li>기존 Docker 컨테이너를 삭제</li>
</ol>
<p>다음과 같은 무중단 방법을 진행하게 되어 Docker 이름 뒤에 붙은 태그 값으로 이전, 현재의 컨테이너를 찾고 있어 container name을 고정하는 것이 불가능했습니다.
Kamal 네트워크처럼 service 이름을 고정하는 것도 방법이지만 아직 추가 배포를 한 적이 없어 실행해보지는 않았습니다.</p>
<h2 id="kamal-config">Kamal Config</h2>
<p>제가 배포에 사용했던 config 정보 입니다.</p>
<p>크게 2가지 버전으로 나뉩니다.</p>
<p>첫번째는 Redmine 단독으로 서비스를 운영하며 kamal-proxy를 활용해 SSL 인증을 받는 가장 기본적인 형태</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">service</span>: <span style="color:#ae81ff">redmine</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">image</span>: <span style="color:#ae81ff">joungsik/redmine</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">servers</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">web</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">&lt;%= ENV.fetch(&#34;SSH_HOST&#34;) %&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">registry</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>: <span style="color:#ae81ff">ghcr.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">&lt;%= ENV.fetch(&#34;REGISTRY_USER&#34;) %&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">KAMAL_REGISTRY_PASSWORD</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">RAILS_MASTER_KEY</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/workspace/redmine_data:/data</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/workspace/redmine_storage:/storage</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/workspace/redmine_plugins:/rails/plugins</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/workspace/redmine_repositories:/gitrepo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">proxy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ssl</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#ae81ff">redmine.joungsik.com</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">builder</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">arch</span>: <span style="color:#ae81ff">amd64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ssh</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>: <span style="color:#ae81ff">&lt;%= ENV.fetch(&#34;SSH_USER&#34;) %&gt;</span>
</span></span></code></pre></div><p>두번째는 nginx-proxy-manager 를 활용해 하나의 물리적 서버에서 여러개의 서비스를 운영하는 형태</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">service</span>: <span style="color:#ae81ff">redmine-app</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">image</span>: <span style="color:#ae81ff">joungsik/redmine</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">servers</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">web</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">&lt;%= ENV.fetch(&#34;SSH_HOST&#34;) %&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">registry</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>: <span style="color:#ae81ff">ghcr.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">&lt;%= ENV.fetch(&#34;REGISTRY_USER&#34;) %&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">KAMAL_REGISTRY_PASSWORD</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">RAILS_MASTER_KEY</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/redmine/data:/data</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/redmine/storage:/storage</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/redmine/plugins:/rails/plugins</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/home/joungsik/redmine/repositories:/gitrepo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">builder</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">arch</span>: <span style="color:#ae81ff">amd64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ssh</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>: <span style="color:#ae81ff">&lt;%= ENV.fetch(&#34;SSH_USER&#34;) %&gt;</span>
</span></span></code></pre></div><p>차이점은 kamal-proxy를 사용하는가? nginx-proxy-manager를 사용하는가?에 대한 차이입니다.</p>
<p>다음은 공통적으로 들어가는 env 값에 대해서 이야기 하려고 합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.env" data-lang=".env"><span style="display:flex;"><span><span style="color:#75715e"># 배포 하려는 서버의 IP 주소</span>
</span></span><span style="display:flex;"><span>SSH_HOST<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 배포 하려는 서버의 접속 User</span>
</span></span><span style="display:flex;"><span>SSH_USER<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker image 를 올리기 위한 저장소 User</span>
</span></span><span style="display:flex;"><span>REGISTRY_USER<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># docker image 를 올리기 위한 저장소 Password</span>
</span></span><span style="display:flex;"><span>KAMAL_REGISTRY_PASSWORD<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># config 에는 나오진 않지만 SSH 접속을 위한 SSH Private Key</span>
</span></span><span style="display:flex;"><span>SSH_PRIVATE_KEY<span style="color:#f92672">=</span>
</span></span></code></pre></div><p>여기서 저는 Docker 이미지 저장소로 AWS의 ECR을 사용하지 않고 GitHub의 Packages를 사용했습니다. Kamal이 AWS와 같은 클라우드 서비스를 탈피하고자 하는 목적이 있는 것 같아 최대한 사용하지 않으려 했습니다.</p>
<p>따라서 GitHub Packages의 user, password 만드는 방법은 따로 검색 후 사용하시면 좋을 것 같습니다.</p>
<h2 id="github-actions">GitHub Actions</h2>
<p>위 config 정보를 기반으로 GitHub Actions를 활용한 deploy.yml 코드입니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">Deploy to Production</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">push</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">branches</span>: [ <span style="color:#ae81ff">main ]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">workflow_dispatch</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deploy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">permissions</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">contents</span>: <span style="color:#ae81ff">read</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">packages</span>: <span style="color:#ae81ff">write</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Checkout code</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Set up Ruby and Install Kamal</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">ruby/setup-ruby@v1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ruby-version</span>: <span style="color:#e6db74">&#39;3.4&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">bundler-cache</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install Kamal</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">run</span>: <span style="color:#ae81ff">gem install kamal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Setup SSH agent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">webfactory/ssh-agent@v0.9.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ssh-private-key</span>: <span style="color:#ae81ff">${{ secrets.SSH_PRIVATE_KEY }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add server to known hosts</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          mkdir -p ~/.ssh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ssh-keyscan -t rsa,dsa,ecdsa,ed25519 ${{ secrets.SSH_HOST }} &gt; ~/.ssh/known_hosts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          chmod 600 ~/.ssh/known_hosts</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Set up Docker for Kamal</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">docker/setup-buildx-action@v3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create .kamal/secrets file</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          mkdir -p .kamal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          cat &gt; .kamal/secrets &lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          KAMAL_REGISTRY_PASSWORD=${{ secrets.GITHUB_TOKEN }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Run Kamal Deploy</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">REGISTRY_USER</span>: <span style="color:#ae81ff">${{ github.actor }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">KAMAL_REGISTRY_PASSWORD</span>: <span style="color:#ae81ff">${{ secrets.GITHUB_TOKEN }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">RAILS_MASTER_KEY</span>: <span style="color:#ae81ff">${{ secrets.RAILS_MASTER_KEY }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">SSH_HOST</span>: <span style="color:#ae81ff">${{ secrets.SSH_HOST }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">SSH_USER</span>: <span style="color:#ae81ff">${{ secrets.SSH_USER }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">KAMAL_VERSION</span>: <span style="color:#ae81ff">${{ github.run_number }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          kamal deploy</span>
</span></span></code></pre></div><p>저는 다음과 같은 형태로 사용하고 있습니다.
그러다보니 아래 5개의 secrets 값을 GitHub repo에 작성해서 사용하고 있습니다.</p>
<ol>
<li>SSH_HOST</li>
<li>SSH_USER</li>
<li>SSH_PRIVATE_KEY</li>
<li>RAILS_MASTER_KEY</li>
<li>KAMAL_REGISTRY_PASSWORD</li>
</ol>
<p>그러면 배포 액션이 돌고 자동으로 서버에도 배포가 되게 됩니다.</p>
<p><img src="github-actions.png" alt="github actions"></p>
<p><img src="docker-ps.png" alt="docker-ps"></p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://joungsik.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://joungsik.github.io/css/toc.css' />

  
<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://joungsik.github.io/css/gitalk.css'>
<script src='https://joungsik.github.io/js/gitalk.min.js'></script>
<script>
  const gitalk = new Gitalk({
    clientID: 'Ov23liEm9fwAxEHDVJuF',
    clientSecret: 'e0e5274a4c8b019883fd841a3948dd0d9333f543',
    repo: 'joungsik.github.io',
    owner: 'JoungSik',
    admin: ['JoungSik'],
    id: eval("location.pathname.substr(0, 50)"), 
    distractionFreeMode: false 
  });
  (function() {
    gitalk.render('gitalk-container');
  })();
</script>

</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://joungsik.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://joungsik.github.io/js/github-style.js"></script>





<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
<script type="application/javascript" src='https://joungsik.github.io/js/search.js'></script>



</html>